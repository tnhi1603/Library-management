<!DOCTYPE html>
<html lang="vn">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Người dùng - Sách đang mượn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/thanh_menu.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/gio_sach.css">
    <link rel="stylesheet" href="/css/chi_tiet_sach.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://kit.fontawesome.com/cfbf817f6f.js" crossorigin="anonymous"></script>
</head>
<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, remove} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyCxSUgNPvToIUGldmsUXgGQXF10aSSH2Hs",
        authDomain: "webapplication-19930.firebaseapp.com",
        databaseURL: "https://webapplication-19930-default-rtdb.firebaseio.com",
        projectId: "webapplication-19930",
        storageBucket: "webapplication-19930.appspot.com",
        messagingSenderId: "240590364295",
        appId: "1:240590364295:web:072e52f18a04f146c12222",
        measurementId: "G-BJXFDHBEBK"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app)
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            const userId = user.uid;

            const borrowingsRef = ref(database, `dues/${userId}`);

            get(borrowingsRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const borrowData = snapshot.val();

                    for (const bookId in borrowData) {
                        // Đường dẫn đến thông tin của mỗi book id
                        const bookInfoRef = ref(database, `books/${bookId}`);

                        // Đọc thông tin từng book id
                        get(bookInfoRef).then((bookSnapshot) => {
                            if (bookSnapshot.exists()) {
                                const bookInfo = bookSnapshot.val();
                                addBookToPage(bookInfo, bookId, borrowData);
                            } else {
                                console.log(`Không tìm thấy thông tin sách với ID ${bookId}`);
                            }
                        }).catch((error) => {
                            console.error(`Lỗi khi đọc thông tin sách với ID ${bookId}:`, error);
                        });
                    }
                } else {
                    // Giỏ hàng không tồn tại hoặc rỗng
                    console.log("Giỏ hàng không tồn tại hoặc rỗng");
                }
            });

        } else {
            // Người dùng chưa đăng nhập
            console.log("User is not logged in");
        }
    });

    function addBookToPage(bookData, bookId, borrowData) {
        var newBox = document.createElement('div');
        newBox.className = 'book-container';
        newBox.setAttribute('data-bookid', bookId);

        var img = document.createElement('img');
        img.className = 'book-image';
        img.src = bookData.Image;
        img.alt = 'Book Image';
        newBox.appendChild(img);

        var info = document.createElement('div');
        info.className = 'book-info';

        var title = document.createElement('p');
        title.innerText = 'Nhan đề: ' + bookData.Title;
        info.appendChild(title);

        var author = document.createElement('p');
        author.innerText = 'Tác giả: ' + bookData.Author;
        info.appendChild(author);

        // Thêm thông tin vào ô sách
        newBox.appendChild(info);

        // Thêm ô sách mới vào container
        var container = document.getElementById('book-info');
        if (container) {
            container.appendChild(newBox);
        } else {
            console.error("Không tìm thấy phần tử với ID 'book-info'");
        }
    }

    //userLink
    document.getElementById("userLink").addEventListener("click", function(event){
              event.preventDefault();
              onAuthStateChanged(auth, (user)=> {
                if (user) {
                  const userEmail = user.email;
                  if(userEmail === "nhom17@gmail.com"){
                    window.location.href = '/src/quan_tri.html';
                  }else{
                  console.log("User login successfully");
                  window.location.href = "/src/nguoi_dung.html";
                  }
                } else {
                  console.log("User not login");
                  window.location.href = "/src/dang_nhap.html";
                }
              });
            });

</script>

<body>
    <div class="wrapper">
        <!--Header-->
        <div class="header">
            <img src="/img/logo.png" alt="LOGO" height="50px" width="auto">
            <div class="toggle">
                <i class="fas fa-bars"></i>
            </div>
            <script>
                $(document).ready(function(){
                    $(".toggle").click(function(){
                        $("nav").slideToggle();
                    })
                });
            </script>
            <nav>
                <ul class="main-menu">
                    <li><a href="/src/trang_chu.html">Trang chủ</a></li>
                    <li class="submenu">
                        <a href="/src/gioi_thieu_gtc.html">Giới thiệu</a>
                        <ul>
                            <li><a href="/src/gioi_thieu_gtc.html">Giới thiệu chung</a></li>
                            <li><a href="/src/gioi_thieu_ddtg.html">Địa điểm & Thời gian hoạt động</a></li>
                            <li><a href="/src/gioi_thieu_tlap.html">Tài liệu - Ấn phẩm</a></li>
                            <li><a href="/src/gioi_thieu_ttpb.html">Thông tin các phòng ban</a></li>
                            <li><a href="/src/gioi_thieu_sd.html">Sơ đồ thư viện</a></li>
                        </ul>
                    </li>
                    <li><a href="/src/muon_sach.html">Mượn sách</a></li>
                    <li class="submenu">
                        <a href="/src/lien_he.html">Liên hệ</a>
                    </li>
                    <!--Icon fontawsome-->
                    <li><a id="now" href="/src/gio_sach.html"><i class="fas fa-cart-shopping"></i></a></li>
                    <li><a href="/src/thong_bao.html"><i class="fas fa-bell"></i></a></li>
                    <li><a href="#" id="userLink"><i class="fas fa-user"></i></a></li>
                </ul>
            </nav>
        </div>
    
        <!--Body-->
        <div class="container">
            <div id="book-info">

            </div>
            <br>
            <hr  width="100%" size="2px" align="center" color="lightgray" />
        </div>
        
        <!--Footer-->
        <div class="footer">
            <div>Địa chỉ: Khu phố 6, Phường Linh Trung, Thành phố Thủ Đức, Thành phố Hồ Chí Minh.</div>
            <div class="social-link">
                <div>Facebook: fb.com/thuvien</div>
                <div>Email: thuvien@gmail.com</div>
                <div>Hotline: 123456789</div>
            </div>
        </div>
    </div>
</body>
</html>