<!DOCTYPE html>
<html lang="vn">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Danh mục sách</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/thanh_menu.css">
    <link rel="stylesheet" href="/css/muon_sach.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/danh_muc_sach.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://kit.fontawesome.com/cfbf817f6f.js" crossorigin="anonymous"></script>
</head>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getDatabase, ref, orderByChild, equalTo, query, get, startAt, endAt} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyCxSUgNPvToIUGldmsUXgGQXF10aSSH2Hs",
        authDomain: "webapplication-19930.firebaseapp.com",
        databaseURL: "https://webapplication-19930-default-rtdb.firebaseio.com",
        projectId: "webapplication-19930",
        storageBucket: "webapplication-19930.appspot.com",
        messagingSenderId: "240590364295",
        appId: "1:240590364295:web:072e52f18a04f146c12222",
        measurementId: "G-BJXFDHBEBK"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app)
    const booksInDB = ref(database, "books")


    get(booksInDB).then((snapshot) => {
            if (snapshot.exists()) {
                snapshot.forEach((bookSnapshot) => {
                    const bookData = bookSnapshot.val();
                    const bookKey = bookSnapshot.key;
                    console.log(bookData);
                    addBookToPage(bookData, bookKey);
                });
            } else {
                searchResults.innerHTML = 'Không tìm thấy kết quả.';
            }
        }).catch((error) => {
            console.error('Lỗi khi thực hiện truy vấn:', error);
        });

    
    // Hàm thêm ô sách vào trang
    function addBookToPage(booksValue, booksKeys) {
        // Tạo một ô sách mới
        var newBox = document.createElement('a');
        newBox.href = 'chi_tiet_sach.html' + '?id=' + booksKeys;
        newBox.className = 'box';

        // Thêm ảnh vào ô sách
        var img = document.createElement('img');
        img.src = booksValue.Image;
        img.alt = 'Book Image';
        newBox.appendChild(img);

        // Thêm tiêu đề sách vào ô sách
        var title = document.createElement('p');
        title.innerText = booksValue.Title;
        newBox.appendChild(title);

        var author = document.createElement('p');
        author.innerText = booksValue.Author;
        newBox.appendChild(author);

        var quantity = document.createElement('p');
        if (booksValue.Quantity > 0) {
            quantity.innerText = "Còn sách";
        }
        else {
            quantity.innerText = "Hết sách";
            quantity.classList.add('out-of-stock');
        }
        newBox.appendChild(quantity);

        // Thêm ô sách mới vào container
        document.getElementById('bookContainer').appendChild(newBox);
    }

    //Hàm tìm kiếm sách
    document.getElementById('searchButton').addEventListener('click', function() {
        let searchInput = document.getElementById('searchInput').value;
        searchInput = String(searchInput);

        // Thực hiện truy vấn Firebase để tìm kiếm
        let queryRef = ref(database, 'books');

        get(queryRef).then((snapshot) => {
            const searchResults = document.getElementById('bookContainer');

            if (snapshot.exists()) {
                searchResults.innerHTML = '';
                snapshot.forEach((childSnapshot) => {
                    const bookData = childSnapshot.val();
                    const bookId = childSnapshot.key;
                    if (bookData.Title.toLowerCase().includes(searchInput.toLowerCase())) {
                        addBookToPage(bookData, bookId);
                    }
                    else if (bookData.Author.toLowerCase().includes(searchInput.toLowerCase())) {
                        addBookToPage(bookData, bookId);
                    }
                    else if(bookData.PublicationYear.toLowerCase().includes(searchInput.toLowerCase())) {
                        addBookToPage(bookData, bookId);
                    }
                });
            } else {
                searchResults.innerHTML = 'Không tìm thấy kết quả.';
            }
        }).catch((error) => {
            console.error('Lỗi khi thực hiện truy vấn:', error);
        });
    });

    //userLink
    document.getElementById("userLink").addEventListener("click", function(event){
              event.preventDefault();
              onAuthStateChanged(auth, (user)=> {
                if (user) {
                  const userEmail = user.email;
                  if(userEmail === "nhom17@gmail.com"){
                    window.location.href = '/src/quan_tri.html';
                  }else{
                  console.log("User login successfully");
                  window.location.href = "/src/nguoi_dung.html";
                  }
                } else {
                  console.log("User not login");
                  window.location.href = "/src/dang_nhap.html";
                }
              });
            });
</script>


<body>
    <div class="wrapper">
        <!--Header-->
        <div class="header">
            <img src="/img/logo.png" alt="LOGO" height="50px" width="auto">
            <div class="toggle">
                <i class="fas fa-bars"></i>
            </div>
            <script>
                $(document).ready(function(){
                    $(".toggle").click(function(){
                        $("nav").slideToggle();
                    })
                });
            </script>
            <nav>
                <ul class="main-menu">
                    <li><a href="/src/trang_chu.html">Trang chủ</a></li>
                    <li class="submenu">
                        <a href="/src/gioi_thieu_gtc.html">Giới thiệu</a>
                        <ul>
                            <li><a href="/src/gioi_thieu_gtc.html">Giới thiệu chung</a></li>
                            <li><a href="/src/gioi_thieu_ddtg.html">Địa điểm & Thời gian hoạt động</a></li>
                            <li><a href="/src/gioi_thieu_tlap.html">Tài liệu - Ấn phẩm</a></li>
                            <li><a href="/src/gioi_thieu_ttpb.html">Thông tin các phòng ban</a></li>
                            <li><a href="/src/gioi_thieu_sd.html">Sơ đồ thư viện</a></li>
                        </ul>
                    </li>
                    <li><a id="now" href="/src/muon_sach.html">Mượn sách</a></li>
                    <li class="submenu">
                        <a href="/src/lien_he.html">Liên hệ</a>
                    </li>
                    <!--Icon fontawsome-->
                    <li><a href="/src/gio_sach.html"><i class="fas fa-cart-shopping"></i></a></li>
                    <li><a href="/src/thong_bao.html"><i class="fas fa-bell"></i></a></li>
                    <li><a href="#" id="userLink"><i class="fas fa-user"></i></a></li>
                </ul>
            </nav>
        </div>

        <!--Body-->
        <br>
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Nhập thông tin tìm kiếm" />
            <button id="searchButton">Tìm Kiếm</button>
        </div>
        <br>
        <div id="searchResults"></div>
        <img src="/img/slide3.png" alt="list">

        <div class="list-container" id="bookContainer">
           
        </div>


        <!--Footer-->
        <div class="footer">
            <div>Địa chỉ: Khu phố 6, Phường Linh Trung, Thành phố Thủ Đức, Thành phố Hồ Chí Minh.</div>
            <div class="social-link">
                <div>Facebook: fb.com/thuvien</div>
                <div>Email: thuvien@gmail.com</div>
                <div>Hotline: 123456789</div>
            </div>
        </div>
    </div>
</body>
</html>
