<!DOCTYPE html>
<html lang="vn">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <title>Mượn sách</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/thanh_menu.css">
    <link rel="stylesheet" href="/css/gio_sach.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/chi_tiet_sach.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://kit.fontawesome.com/cfbf817f6f.js" crossorigin="anonymous"></script>
</head>

<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
    import { getDatabase, ref, get, set, remove, update} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "AIzaSyCxSUgNPvToIUGldmsUXgGQXF10aSSH2Hs",
        authDomain: "webapplication-19930.firebaseapp.com",
        databaseURL: "https://webapplication-19930-default-rtdb.firebaseio.com",
        projectId: "webapplication-19930",
        storageBucket: "webapplication-19930.appspot.com",
        messagingSenderId: "240590364295",
        appId: "1:240590364295:web:072e52f18a04f146c12222",
        measurementId: "G-BJXFDHBEBK"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app)
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            // Người dùng đã đăng nhập, lấy user id
            const userId = user.uid;

            // Đường dẫn đến giỏ hàng của người dùng
            const cartRef = ref(database, `carts/${userId}`);

            // Sử dụng phương thức get để đọc thông tin từ giỏ hàng
            get(cartRef).then((snapshot) => {
                if (snapshot.exists()) {
                    // Giỏ hàng tồn tại, lấy dữ liệu từ snapshot.val()
                    const cartData = snapshot.val();

                    // Lặp qua từng book id trong giỏ hàng
                    for (const bookId in cartData) {
                        // Đường dẫn đến thông tin của mỗi book id
                        const bookInfoRef = ref(database, `books/${bookId}`);

                        // Đọc thông tin từng book id
                        update(bookInfoRef).then((bookSnapshot) => {
                            if (bookSnapshot.exists()) {
                                const bookInfo = bookSnapshot.val();
                                console.log(`Thông tin sách với ID ${bookId}:`, bookInfo);
                                addBookToPage(bookInfo, bookId);
                            } else {
                                console.log(`Không tìm thấy thông tin sách với ID ${bookId}`);
                            }
                        }).catch((error) => {
                            console.error(`Lỗi khi đọc thông tin sách với ID ${bookId}:`, error);
                        });
                    }
                } else {
                    // Giỏ hàng không tồn tại hoặc rỗng
                    console.log("Giỏ hàng không tồn tại hoặc rỗng");
                }
            });

        } else {
            // Người dùng chưa đăng nhập
            console.log("User is not logged in");
        }
    });

    function addBookToPage(bookData, bookId) {
        var newBox = document.createElement('div');
        newBox.className = 'book-container';
        newBox.setAttribute('data-bookid', bookId);

        var img = document.createElement('img');
        img.className = 'book-image';
        img.src = bookData.Image;
        img.alt = 'Book Image';

        // Thêm checkbox
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = bookId; // Đặt ID cho checkbox (có thể sử dụng ID của sách hoặc thông tin khác)
        checkbox.className = "book-checkbox";

        // Thêm ảnh và checkbox vào ô sách
        newBox.appendChild(checkbox);
        newBox.appendChild(img);

        var info = document.createElement('div');
        info.className = 'book-info';

        var title = document.createElement('p');
        title.innerText = 'Nhan đề: ' + bookData.Title;
        info.appendChild(title);

        var author = document.createElement('p');
        author.innerText = 'Tác giả: ' + bookData.Author;
        info.appendChild(author);

        var quantity = document.createElement('p');
        quantity.innerText = 'Số lượng: ' + bookData.Quantity;
        info.appendChild(quantity);

        var status = document.createElement('p');
        status.innerText = "Tình trạng: ";

        var statusText = document.createElement('span');
        if (bookData.Quantity > 0) {
            statusText.innerText = "Còn sách";
        } else {
            statusText.innerText = "Hết sách";
            statusText.classList.add('out-of-stock');
        }
        status.appendChild(statusText);
        info.appendChild(status);

        var borrowDates = document.createElement('input');
        borrowDates.type = "number";
        borrowDates.className = "days-input";
        borrowDates.placeholder = "Số ngày muốn mượn";
        info.appendChild(borrowDates);

        var deleteButton = document.createElement('span');
        deleteButton.id = "delete";
        deleteButton.innerText = 'Xóa';
        deleteButton.addEventListener('click', function() {
            // Lấy bookId từ thuộc tính dữ liệu (data-bookid) của ô sách
            var bookId = newBox.getAttribute('data-bookid');

            // Gọi hàm xóa sách với bookId
            handleDelete(bookId);
        });
        info.appendChild(deleteButton);

        // Thêm thông tin vào ô sách
        newBox.appendChild(info);

        // Thêm ô sách mới vào container
        var container = document.getElementById('book-info');
        if (container) {
            container.appendChild(newBox);
        } else {
            console.error("Không tìm thấy phần tử với ID 'book-info'");
        }
    }

document.getElementById('br').addEventListener('click', function() {
    // Lấy tất cả các ô sách được chọn
    var selectedBooks = document.querySelectorAll('.book-container input.book-checkbox:checked');
    // Duyệt qua từng ô sách được chọn
    selectedBooks.forEach(function(book) {
        var bookContainer = book.closest('.book-container');
        var bookId = book.id
        
        var daysInput = bookContainer.querySelector('.days-input');
        var numberOfDays = daysInput.value;
        // Kiểm tra nếu số ngày hợp lệ (có thể thêm kiểm tra khác tùy ý)
        if (numberOfDays && numberOfDays > 0) {
            // Gọi hàm xử lý mượn sách với bookId và numberOfDays
            handleBorrow(bookId, numberOfDays);
        } else {
            console.log('Vui lòng nhập số ngày hợp lệ cho sách có ID ' + bookId);
        }
    });
});

function handleBorrow(bookId, numberOfDays) {
    onAuthStateChanged(auth, (user) => {
        if (user) {
            var userId = user.uid;

            // Đường dẫn đến giỏ hàng của người dùng
            const cartRef = ref(database, `carts/${userId}/${bookId}`);

            // Lấy dữ liệu từ giỏ hàng
            get(cartRef).then(function(snapshot) {
                var cartData = snapshot.val();

                if (cartData) {
                    // Lấy ngày hiện tại
                    var currentDate = new Date();

                    // Tính ngày trả bằng cách thêm số ngày mượn vào ngày hiện tại
                    var returnDate = new Date(currentDate);
                    returnDate.setDate(returnDate.getDate() + parseInt(numberOfDays));

                    // Đường dẫn đến bảng borrowings
                    var borrowingsRef = ref(database, `borrowings/${userId}`);
                    get(borrowingsRef).then(function(borrowingsSnapshot) {
                        var borrowingsData = borrowingsSnapshot.val();

                        if (borrowingsData && borrowingsData[bookId]) {
                            // Nếu bookId đã tồn tại trong bảng borrowings
                            alert('Bạn đã mượn sách này!');
                        } else {

                            // Thêm thông tin mượn sách vào bảng borrowings
                            set(borrowingsRef, {
                                [bookId]: {
                                borrowDate: currentDate.toISOString().split('T')[0],
                                returnDate: returnDate.toISOString().split('T')[0]
                                }
                            });
                            const bookInfoRef = ref(database, `books/${bookId}`);
                            get(bookInfoRef).then((bookSnapshot) => {
                                const bookData = bookSnapshot.val();
                                update(bookInfoRef, { Quantity: bookData.Quantity - 1 });
                                console.log('Đã mượn sách thành công!');
                                window.location.href = 'gio_sach.html';
                            });
                            // Xóa giỏ hàng sau khi đã mượn sách
                            remove(cartRef);
                        }
                    });
                } else {
                    console.log('Giỏ hàng trống rỗng!');
                }
            }).catch(function(error) {
                console.error('Lỗi khi đọc dữ liệu từ giỏ hàng:', error);
            });
        } else {
            console.log('Người dùng chưa đăng nhập!');
        }
    });
}

function handleDelete(bookId) {
    onAuthStateChanged(auth, (user) => {
        if (user) {
            var userId = user.uid;

            // Đường dẫn đến giỏ hàng của người dùng
            const cartRef = ref(database, `carts/${userId}/${bookId}`);

            // Lấy dữ liệu từ giỏ hàng
            get(cartRef).then(function(snapshot) {
                var cartData = snapshot.val();
                    remove(cartRef);

                    // Hiển thị thông báo hoặc thực hiện các công việc khác sau khi mượn sách thành công
                    console.log('Đã mượn sách thành công!');
                    window.location.href = 'gio_sach.html';
            }).catch(function(error) {
                console.error('Lỗi khi đọc dữ liệu từ giỏ hàng:', error);
            });
        } else {
            console.log('Người dùng chưa đăng nhập!');
        }
    });
}

</script>

<body>
    <div class="wrapper">
        <!--Header-->
        <div class="header">
            <img src="/img/logo.png" alt="LOGO" height="50px" width="auto">
            <div class="toggle">
                <i class="fas fa-bars"></i>
            </div>
            <script>
                $(document).ready(function(){
                    $(".toggle").click(function(){
                        $("nav").slideToggle();
                    })
                });
            </script>
            <nav>
                <ul class="main-menu">
                    <li><a href="/src/trang_chu.html">Trang chủ</a></li>
                    <li class="submenu">
                        <a href="/src/gioi_thieu_gtc.html">Giới thiệu</a>
                        <ul>
                            <li><a href="/src/gioi_thieu_gtc.html">Giới thiệu chung</a></li>
                            <li><a href="/src/gioi_thieu_ddtg.html">Địa điểm & Thời gian hoạt động</a></li>
                            <li><a href="/src/gioi_thieu_tlap.html">Tài liệu - Ấn phẩm</a></li>
                            <li><a href="/src/gioi_thieu_ttpb.html">Thông tin các phòng ban</a></li>
                            <li><a href="/src/gioi_thieu_sd.html">Sơ đồ thư viện</a></li>
                        </ul>
                    </li>
                    <li><a href="/src/muon_sach.html">Mượn sách</a></li>
                    <li class="submenu">
                        <a href="/src/lien_he.html">Liên hệ</a>
                    </li>
                    <!--Icon fontawsome-->
                    <li><a id="now" href="/src/gio_sach.html"><i class="fas fa-cart-shopping"></i></a></li>
                    <li><a href="/src/thong_bao.html"><i class="fas fa-bell"></i></a></li>
                    <li><a href="/src/nguoi_dung.html"><i class="fas fa-user"></i></a></li>
                </ul>
            </nav>
        </div>
    
        <!--Body-->
        <h1>Trang chủ / Giỏ sách</h1>
        <div class="container">
            <div id="book-info">

            </div>
            <br>
            <hr  width="100%" size="2px" align="center" color="lightgray" />
            <button id="br">Mượn sách</button>
        </div>
        
        <!--Footer-->
        <div class="footer">
            <div>Địa chỉ: Khu phố 6, Phường Linh Trung, Thành phố Thủ Đức, Thành phố Hồ Chí Minh.</div>
            <div class="social-link">
                <div>Facebook: fb.com/thuvien</div>
                <div>Email: thuvien@gmail.com</div>
                <div>Hotline: 123456789</div>
            </div>
        </div>
    </div>
</body>
</html>
